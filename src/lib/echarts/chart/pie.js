define("echarts/chart/pie",["require","./base","zrender/shape/Text","zrender/shape/Ring","zrender/shape/Circle","zrender/shape/Sector","zrender/shape/Polyline","../config","../util/ecData","zrender/tool/util","zrender/tool/math","zrender/tool/color","../chart"],function(t){function e(t,e,n,a,o){i.call(this,t,e,n,a,o);var s=this;s.shapeHandler.onmouseover=function(t){var e=t.target,i=h.get(e,"seriesIndex"),n=h.get(e,"dataIndex"),a=h.get(e,"special"),o=[e.style.x,e.style.y],r=e.style.startAngle,l=e.style.endAngle,d=((l+r)/2+360)%360,p=e.highlightStyle.color,m=s.getLabel(i,n,a,o,d,p,!0);m&&s.zr.addHoverShape(m);var c=s.getLabelLine(i,n,o,e.style.r0,e.style.r,d,p,!0);c&&s.zr.addHoverShape(c)},this.refresh(a)}var i=t("./base"),n=t("zrender/shape/Text"),a=t("zrender/shape/Ring"),o=t("zrender/shape/Circle"),s=t("zrender/shape/Sector"),r=t("zrender/shape/Polyline"),l=t("../config"),h=t("../util/ecData"),d=t("zrender/tool/util"),p=t("zrender/tool/math"),m=t("zrender/tool/color");return e.prototype={type:l.CHART_TYPE_PIE,_buildShape:function(){var t=this.series,e=this.component.legend;this.selectedMap={},this._selected={};var i,n,s;this._selectedMode=!1;for(var r,d=0,p=t.length;p>d;d++)if(t[d].type===l.CHART_TYPE_PIE){if(t[d]=this.reformOption(t[d]),this.legendHoverLink=t[d].legendHoverLink||this.legendHoverLink,r=t[d].name||"",this.selectedMap[r]=e?e.isSelected(r):!0,!this.selectedMap[r])continue;i=this.parseCenter(this.zr,t[d].center),n=this.parseRadius(this.zr,t[d].radius),this._selectedMode=this._selectedMode||t[d].selectedMode,this._selected[d]=[],this.deepQuery([t[d],this.option],"calculable")&&(s={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:i[0],y:i[1],r0:n[0]<=10?0:n[0]-10,r:n[1]+10,brushType:"stroke",lineWidth:1,strokeColor:t[d].calculableHolderColor||this.ecTheme.calculableHolderColor}},h.pack(s,t[d],d,void 0,-1),this.setCalculable(s),s=n[0]<=10?new o(s):new a(s),this.shapeList.push(s)),this._buildSinglePie(d),this.buildMark(d)}this.addShapeList()},_buildSinglePie:function(t){for(var e,i=this.series,n=i[t],a=n.data,o=this.component.legend,s=0,r=0,l=0,h=Number.NEGATIVE_INFINITY,d=[],p=0,m=a.length;m>p;p++)e=a[p].name,this.selectedMap[e]=o?o.isSelected(e):!0,this.selectedMap[e]&&!isNaN(a[p].value)&&(0!==+a[p].value?s++:r++,l+=+a[p].value,h=Math.max(h,+a[p].value));if(0!==l){for(var c,u,g,y,f,V,U=100,_=n.clockWise,b=(n.startAngle.toFixed(2)-0+360)%360,x=n.minAngle||.01,k=360-x*s-.01*r,v=n.roseType,p=0,m=a.length;m>p;p++)if(e=a[p].name,this.selectedMap[e]&&!isNaN(a[p].value)){if(u=o?o.getColor(e):this.zr.getColor(p),U=a[p].value/l,c="area"!=v?_?b-U*k-(0!==U?x:.01):U*k+b+(0!==U?x:.01):_?b-360/m:360/m+b,c=c.toFixed(2)-0,U=(100*U).toFixed(2),g=this.parseCenter(this.zr,n.center),y=this.parseRadius(this.zr,n.radius),f=+y[0],V=+y[1],"radius"===v?V=a[p].value/h*(V-f)*.8+.2*(V-f)+f:"area"===v&&(V=Math.sqrt(a[p].value/h)*(V-f)+f),_){var L;L=b,b=c,c=L}this._buildItem(d,t,p,U,a[p].selected,g,f,V,b,c,u),_||(b=c)}this._autoLabelLayout(d,g,V);for(var p=0,m=d.length;m>p;p++)this.shapeList.push(d[p]);d=null}},_buildItem:function(t,e,i,n,a,o,s,r,l,d,p){var m=this.series,c=((d+l)/2+360)%360,u=this.getSector(e,i,n,a,o,s,r,l,d,p);h.pack(u,m[e],e,m[e].data[i],i,m[e].data[i].name,n),t.push(u);var g=this.getLabel(e,i,n,o,c,p,!1),y=this.getLabelLine(e,i,o,s,r,c,p,!1);y&&(h.pack(y,m[e],e,m[e].data[i],i,m[e].data[i].name,n),t.push(y)),g&&(h.pack(g,m[e],e,m[e].data[i],i,m[e].data[i].name,n),g._labelLine=y,t.push(g))},getSector:function(t,e,i,n,a,o,r,l,h,d){var c=this.series,u=c[t],g=u.data[e],y=[g,u],f=this.deepMerge(y,"itemStyle.normal")||{},V=this.deepMerge(y,"itemStyle.emphasis")||{},U=this.getItemStyleColor(f.color,t,e,g)||d,_=this.getItemStyleColor(V.color,t,e,g)||("string"==typeof U?m.lift(U,-.2):U),b={zlevel:this.getZlevelBase(),z:this.getZBase(),clickable:this.deepQuery(y,"clickable"),style:{x:a[0],y:a[1],r0:o,r:r,startAngle:l,endAngle:h,brushType:"both",color:U,lineWidth:f.borderWidth,strokeColor:f.borderColor,lineJoin:"round"},highlightStyle:{color:_,lineWidth:V.borderWidth,strokeColor:V.borderColor,lineJoin:"round"},_seriesIndex:t,_dataIndex:e};if(n){var x=((b.style.startAngle+b.style.endAngle)/2).toFixed(2)-0;b.style._hasSelected=!0,b.style._x=b.style.x,b.style._y=b.style.y;var k=this.query(u,"selectedOffset");b.style.x+=p.cos(x,!0)*k,b.style.y-=p.sin(x,!0)*k,this._selected[t][e]=!0}else this._selected[t][e]=!1;return this._selectedMode&&(b.onclick=this.shapeHandler.onclick),this.deepQuery([g,u,this.option],"calculable")&&(this.setCalculable(b),b.draggable=!0),(this._needLabel(u,g,!0)||this._needLabelLine(u,g,!0))&&(b.onmouseover=this.shapeHandler.onmouseover),b=new s(b)},getLabel:function(t,e,i,a,o,s,r){var l=this.series,h=l[t],m=h.data[e];if(this._needLabel(h,m,r)){var c,u,g,y=r?"emphasis":"normal",f=d.merge(d.clone(m.itemStyle)||{},h.itemStyle),V=f[y].label,U=V.textStyle||{},_=a[0],b=a[1],x=this.parseRadius(this.zr,h.radius),k="middle";V.position=V.position||f.normal.label.position,"center"===V.position?(c=_,u=b,g="center"):"inner"===V.position||"inside"===V.position?(x=(x[0]+x[1])*(V.distance||.5),c=Math.round(_+x*p.cos(o,!0)),u=Math.round(b-x*p.sin(o,!0)),s="#fff",g="center"):(x=x[1]- -f[y].labelLine.length,c=Math.round(_+x*p.cos(o,!0)),u=Math.round(b-x*p.sin(o,!0)),g=o>=90&&270>=o?"right":"left"),"center"!=V.position&&"inner"!=V.position&&"inside"!=V.position&&(c+="left"===g?20:-20),m.__labelX=c-("left"===g?5:-5),m.__labelY=u;var v=new n({zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{x:c,y:u,color:U.color||s,text:this.getLabelText(t,e,i,y),textAlign:U.align||g,textBaseline:U.baseline||k,textFont:this.getFont(U)},highlightStyle:{brushType:"fill"}});return v._radius=x,v._labelPosition=V.position||"outer",v._rect=v.getRect(v.style),v._seriesIndex=t,v._dataIndex=e,v}},getLabelText:function(t,e,i,n){var a=this.series,o=a[t],s=o.data[e],r=this.deepQuery([s,o],"itemStyle."+n+".label.formatter");return r?"function"==typeof r?r.call(this.myChart,o.name,s.name,s.value,i):"string"==typeof r?(r=r.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{d}","{d0}"),r=r.replace("{a0}",o.name).replace("{b0}",s.name).replace("{c0}",s.value).replace("{d0}",i)):void 0:s.name},getLabelLine:function(t,e,i,n,a,o,s,l){var h=this.series,m=h[t],c=m.data[e];if(this._needLabelLine(m,c,l)){var u=l?"emphasis":"normal",g=d.merge(d.clone(c.itemStyle)||{},m.itemStyle),y=g[u].labelLine,f=y.lineStyle||{},V=i[0],U=i[1],_=a,b=this.parseRadius(this.zr,m.radius)[1]- -y.length,x=p.cos(o,!0),k=p.sin(o,!0);return new r({zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{pointList:[[V+_*x,U-_*k],[V+b*x,U-b*k],[c.__labelX,c.__labelY]],strokeColor:f.color||s,lineType:f.type,lineWidth:f.width},_seriesIndex:t,_dataIndex:e})}},_needLabel:function(t,e,i){return this.deepQuery([e,t],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(t,e,i){return this.deepQuery([e,t],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},_autoLabelLayout:function(t,e,i){for(var n=[],a=[],o=0,s=t.length;s>o;o++)("outer"===t[o]._labelPosition||"outside"===t[o]._labelPosition)&&(t[o]._rect._y=t[o]._rect.y,t[o]._rect.x<e[0]?n.push(t[o]):a.push(t[o]));this._layoutCalculate(n,e,i,-1),this._layoutCalculate(a,e,i,1)},_layoutCalculate:function(t,e,i,n){function a(e,i,n){for(var a=e;i>a;a++)if(t[a]._rect.y+=n,t[a].style.y+=n,t[a]._labelLine&&(t[a]._labelLine.style.pointList[1][1]+=n,t[a]._labelLine.style.pointList[2][1]+=n),a>e&&i>a+1&&t[a+1]._rect.y>t[a]._rect.y+t[a]._rect.height)return void o(a,n/2);o(i-1,n/2)}function o(e,i){for(var n=e;n>=0&&(t[n]._rect.y-=i,t[n].style.y-=i,t[n]._labelLine&&(t[n]._labelLine.style.pointList[1][1]-=i,t[n]._labelLine.style.pointList[2][1]-=i),!(n>0&&t[n]._rect.y>t[n-1]._rect.y+t[n-1]._rect.height));n--);}function s(t,e,i,n,a){for(var o,s,r,l=i[0],h=i[1],d=a>0?e?Number.MAX_VALUE:0:e?Number.MAX_VALUE:0,p=0,m=t.length;m>p;p++)s=Math.abs(t[p]._rect.y-h),r=t[p]._radius-n,o=n+r>s?Math.sqrt((n+r+20)*(n+r+20)-Math.pow(t[p]._rect.y-h,2)):Math.abs(t[p]._rect.x+(a>0?0:t[p]._rect.width)-l),e&&o>=d&&(o=d-10),!e&&d>=o&&(o=d+10),t[p]._rect.x=t[p].style.x=l+o*a,t[p]._labelLine.style.pointList[2][0]=l+(o-5)*a,t[p]._labelLine.style.pointList[1][0]=l+(o-20)*a,d=o}t.sort(function(t,e){return t._rect.y-e._rect.y});for(var r,l=0,h=t.length,d=[],p=[],m=0;h>m;m++)r=t[m]._rect.y-l,0>r&&a(m,h,-r,n),l=t[m]._rect.y+t[m]._rect.height;this.zr.getHeight()-l<0&&o(h-1,l-this.zr.getHeight());for(var m=0;h>m;m++)t[m]._rect.y>=e[1]?p.push(t[m]):d.push(t[m]);s(p,!0,e,i,n),s(d,!1,e,i,n)},reformOption:function(t){var e=d.merge;return t=e(t||{},this.ecTheme.pie),t.itemStyle.normal.label.textStyle=e(t.itemStyle.normal.label.textStyle||{},this.ecTheme.textStyle),t.itemStyle.emphasis.label.textStyle=e(t.itemStyle.emphasis.label.textStyle||{},this.ecTheme.textStyle),t},refresh:function(t){t&&(this.option=t,this.series=t.series),this.backupShapeList(),this._buildShape()},addDataAnimation:function(t){for(var e=this.series,i={},n=0,a=t.length;a>n;n++)i[t[n][0]]=t[n];var o={},s={},r={},h=this.shapeList;this.shapeList=[];for(var d,p,m,c={},n=0,a=t.length;a>n;n++)d=t[n][0],p=t[n][2],m=t[n][3],e[d]&&e[d].type===l.CHART_TYPE_PIE&&(p?(m||(o[d+"_"+e[d].data.length]="delete"),c[d]=1):m?c[d]=0:(o[d+"_-1"]="delete",c[d]=-1),this._buildSinglePie(d));for(var u,g,n=0,a=this.shapeList.length;a>n;n++)switch(d=this.shapeList[n]._seriesIndex,u=this.shapeList[n]._dataIndex,g=d+"_"+u,this.shapeList[n].type){case"sector":o[g]=this.shapeList[n];break;case"text":s[g]=this.shapeList[n];break;case"polyline":r[g]=this.shapeList[n]}this.shapeList=[];for(var y,n=0,a=h.length;a>n;n++)if(d=h[n]._seriesIndex,i[d]){if(u=h[n]._dataIndex+c[d],g=d+"_"+u,y=o[g],!y)continue;if("sector"===h[n].type)"delete"!=y?this.zr.animate(h[n].id,"style").when(400,{startAngle:y.style.startAngle,endAngle:y.style.endAngle}).start():this.zr.animate(h[n].id,"style").when(400,c[d]<0?{startAngle:h[n].style.startAngle}:{endAngle:h[n].style.endAngle}).start();else if("text"===h[n].type||"polyline"===h[n].type)if("delete"===y)this.zr.delShape(h[n].id);else switch(h[n].type){case"text":y=s[g],this.zr.animate(h[n].id,"style").when(400,{x:y.style.x,y:y.style.y}).start();break;case"polyline":y=r[g],this.zr.animate(h[n].id,"style").when(400,{pointList:y.style.pointList}).start()}}this.shapeList=h},onclick:function(t){var e=this.series;if(this.isClick&&t.target){this.isClick=!1;for(var i,n=t.target,a=n.style,o=h.get(n,"seriesIndex"),s=h.get(n,"dataIndex"),r=0,d=this.shapeList.length;d>r;r++)if(this.shapeList[r].id===n.id){if(o=h.get(n,"seriesIndex"),s=h.get(n,"dataIndex"),a._hasSelected)n.style.x=n.style._x,n.style.y=n.style._y,n.style._hasSelected=!1,this._selected[o][s]=!1;else{var m=((a.startAngle+a.endAngle)/2).toFixed(2)-0;n.style._hasSelected=!0,this._selected[o][s]=!0,n.style._x=n.style.x,n.style._y=n.style.y,i=this.query(e[o],"selectedOffset"),n.style.x+=p.cos(m,!0)*i,n.style.y-=p.sin(m,!0)*i}this.zr.modShape(n.id,n)}else this.shapeList[r].style._hasSelected&&"single"===this._selectedMode&&(o=h.get(this.shapeList[r],"seriesIndex"),s=h.get(this.shapeList[r],"dataIndex"),this.shapeList[r].style.x=this.shapeList[r].style._x,this.shapeList[r].style.y=this.shapeList[r].style._y,this.shapeList[r].style._hasSelected=!1,this._selected[o][s]=!1,this.zr.modShape(this.shapeList[r].id,this.shapeList[r]));this.messageCenter.dispatch(l.EVENT.PIE_SELECTED,t.event,{selected:this._selected,target:h.get(n,"name")},this.myChart),this.zr.refresh()}}},d.inherits(e,i),t("../chart").define("pie",e),e});